#/bin/bash

export rsp_location=$(pwd)
export oracle_home=/u01/app/oracle/product/12.2.1/OEP/oep/common/bin
export ORACLE_BASE=/u01/app/oracle
export MW_HOME=${ORACLE_BASE}/product/12.2.1/OEP

echo "Start configuration"

echo "Create DB User"
sqlresult=$(sqlplus sys/welcome1  as sysdba <<EOF
DROP USER oep_db_user;
CREATE USER oep_db_user IDENTIFIED BY welcome1;
GRANT CREATE SESSION TO oep_db_user;
exit;
EOF
)

if [[ $sqlresult =~ "User created" ]] ;
then
  echo "Successfully created database user oep_db_user"
else
  echo "Failed creating database user oep_db_user\n\n" ;
  echo -e "Examine output below for details;\n\n"
  printf '=%.0s' {1..80}
  echo "$sqlresult" | sed 's/^/\t/'
  printf '=%.0s' {1..80}
  echo -e "\n"
  exit
fi

echo "Creating domain"
cd $oracle_home
./config.sh -mode=silent -silent_xml=${rsp_location}/oep_domain_config.xml -log=/tmp/create_oep_domain.log


echo "Starting StreamExplorer domain"
cd /u01/data/domains/oep12c/oep_server1

nohup ./startwlevs.sh 2>/dev/null >/var/tmp/start_wlevs.out &
sleep 2
echo 'Starting StreamExplorer'
tail -f /var/tmp/start_wlevs.out | while read LOGLINE
do
   [[ "${LOGLINE}" == *"Initiating Jersey application"* ]] && pkill -P $$ tail
   echo -en ">"
done
echo '-'
echo 'Started StreamExplorer'
sleep 5

echo "Shutting down StreamExplorer domain"
nohup ./stopwlevs.sh 2>/dev/null >/var/tmp/stop_wlevs.out &
echo 'Stopping StreamExplorer'
tail -F /u01/data/domains/oep12c/oep_server1/server.log | while read LOGLINE
do
   [[ "${LOGLINE}" == *"Server STOPPED"* ]] && pkill -P $$ tail
   echo -en ">"
done
echo '-'
echo 'Stopped StreamExplorer'
sleep 5

echo "Install SX Samples"
cp ${rsp_location}/sxsamples*.zip /u01/data/domains/oep12c/oep_server1/sx_patches

echo "Creating control scripts"
cat <<EOF > /u01/data/domains/oep12c/oep_server1/startoep.sh
cd /u01/data/domains/oep12c/oep_server1
./startwlevs.sh
EOF
chmod u+x /u01/data/domains/oep12c/oep_server1/startoep.sh

cat <<EOF > /u01/data/domains/oep12c/oep_server1/stopoep.sh
cd /u01/data/domains/oep12c/oep_server1
./stopwlevs.sh
EOF
chmod u+x /u01/data/domains/oep12c/oep_server1/stopoep.sh


sudo -E bash -c 'cat > /usr/share/applications/StartStreamExplorer.desktop <<EOF
#!/usr/bin/env xdg-open

[Desktop Entry]
Version=1.0
Type=Application
Terminal=false
Name[en_US]=Start Stream Explorer
Exec=/u01/data/domains/oep12c/oep_server1/startoep.sh
Name=Start Stream Explorer
Categories=FusionMiddleware
EOF'

sudo -E bash -c 'cat > /usr/share/applications/StopStreamExplorer.desktop <<EOF
#!/usr/bin/env xdg-open

[Desktop Entry]
Version=1.0
Type=Application
Terminal=false
Name[en_US]=Stop Stream Explorer
Exec=/u01/data/domains/oep12c/oep_server1/stopoep.sh
Name=Stop Stream Explorer
Categories=FusionMiddleware
EOF'
